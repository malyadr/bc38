pipeline {
    agent any
    environment {
        DOCKERHUB_CREDENTIALS=credentials('malyadr')
        PROJECT_ID = 'static-ceiling-361209'
        CLUSTER_NAME = 'terraform-cluster'	
        LOCATION = 'us-west1'
        CREDENTIALS_ID = 'My First Project'
    }
    stages {
        stage('Docker Build') {
          steps {
            sh "cd frontend ; ls ; docker build --file Dockerfile -t ghcr.io/malyadr/mock:latest ."
      }
    }
        stage('Docker push') {
          steps {
            sh  "echo $DOCKERHUB_CREDENTIALS_PSW | docker login ghcr.io -u $DOCKERHUB_CREDENTIALS_USR --password-stdin; docker push ghcr.io/malyadr/mock:latest"

            
      }
    }
        stage('Deploy to eks') {
          steps {
            script{
              step([$class: 'KubernetesEngineBuilder', projectId: env.PROJECT_ID, clusterName: env.CLUSTER_NAME, location: env.LOCATION, manifestPattern: 'mockserver.yaml', credentialsId: env.CREDENTIALS_ID, verifyDeployments: true])
              sh kubectl apply -f frontend/mockserver.yaml
            }
            
      }
    }
 }  
} 

