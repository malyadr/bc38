variables:
    SONAR_USER_HOME: '${CI_PROJECT_DIR}/.sonar' # Defines the location of the analysis task cache
    GIT_DEPTH: '0' # Tells git to fetch all the branches of the project, required by the analysis task

stages:
    - sonarcloud-check-frontend
    - netlify

sonarcloud-check-frontend:
    stage: sonarcloud-check-frontend
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: ['']
    cache:
        key: '${CI_JOB_NAME}'
        paths:
            - .sonar/cache
    script:
        - apt install sudo
        - sudo apt update
        - sudo apt install nodejs npm
        - npm install
        - npm test
        - sonar-scanner
    only:
        - merge_requests
        - main

netlify:
    stage: netlify
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: ['']
    script:
        - npm run build-storybook
        - npx netlify-cli deploy --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN --prod --dir=storybook-static
    only:
        - merge_requests
        - main